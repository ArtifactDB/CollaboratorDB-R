---
title: R client for CollaboratorDB
author:
- name: Aaron Lun
  email: infinite.monkeys.with.keyboards@gmail.com
package: zircon
date: "Revised: January 19, 2023"
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Using the CollaboratorDB R client}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
library(BiocStyle)
self <- Githubpkg("ArtifactDB/CollaboratorDB-R", "CollaboratorDB");
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE)
```

# Introduction

`r self` implements a simple R client for interacting with the **CollaboratorDB** API.
**CollaboratorDB** provides a publicly accessible store for Bioconductor objects based on the [schemas here](https://github.com/ArtifactDB/CollaboratorDB-schemas),
and is intended to enable a smooth exchange of data and results between gRED scientists and their external collaborators.
Functionality is provided to read objects from the backend, to save objects in new projects, and to save new versions of existing projects.

# Fetching objects from the backend

The `fetchObject()` function will load an R object from the **CollaboratorDB** backend, given the object's identifier:

```{r}
library(CollaboratorDB)
(id <- exampleID())
obj <- fetchObject(id)
obj
```

We can extract the metadata using the `objectAnnotation()` function:

```{r}
str(objectAnnotation(obj))
```

More complex objects can be loaded if the corresponding [**alabaster**](https://github.com/ArtifactDB/alabaster.base) packages are installed.
For example, we can load [`SingleCellExperiment`](https://bioconductor.org/packages/SingleCellExperiment) objects if `r Githubpkg("ArtifactDB/alabaster.sce")` is installed.

```{r}
fetchObject("dssc-test_basic-2023:my_first_sce@2023-01-19")
```

# Saving objects 

Given some Bioconductor objects, we can annotate them with relevant metadata.
Most of these should be self-explanatory; the most novel field is `terms`, consisting of (optional) terms from some supported ontologies that enable easier programmatic annotation.

```{r}
library(S4Vectors)
df1 <- DataFrame(A=runif(10), B=rnorm(10), row.names=LETTERS[1:10])
df1 <- annotateObject(df1, 
    title="FOO",
    description="Ich bien ein data frame",
    authors="Aaron Lun <infinite.monkeys.with.keyboards@gmail.com>",
    species=9606,
    genome=list(list(id="hg38", source="UCSC")),
    origin=list(list(source="PubMed", id="123456789")),
    terms=list(list(id="EFO:0008896", source="Experimental Factor Ontology", version="v3.39.1"))
)
```

Then we save the object into a "staging directory":

```{r}
staging <- tempfile()
dir.create(staging)
saveObject(df1, staging, "df001")
list.files(staging, recursive=TRUE)
```

Any name can be used for the objects, and multiple objects can be saved into the same directory.
Objects can even be saved into subdirectories:

```{r}
df2 <- DataFrame(A=runif(10), B=rnorm(10), row.names=LETTERS[1:10])
df2 <- annotateObject(df1, 
    title="BAR",
    description="Je suis une data frame",
    authors=list(list(name="Darth Vader", email="vader@empire.gov", orcid="0000-0000-0000-0001")),
    species=10090,
    genome=list(list(id="GRCm38", source="Ensembl")),
    origin=list(list(source="GEO", id="GSE123456"))
)

dir.create(file.path(staging, "variants"))
saveObject(df2, staging, "variants/df002")
list.files(staging, recursive=TRUE)
```

Once we're done with staging, we're ready to upload.
We pick a project name and version and call the `uploadDirectory()` function.
This will prompt us for a [GitHub personal access token](https://github.com/settings/tokens) to authenticate into the backend, if we haven't supplied one already.

ðŸš¨ðŸš¨ðŸš¨ **ALERT!**
For cost and security reasons, the **CollaboratorDB** instance only allows GitHub users from the [CollaboratorDB](https://github.com/CollaboratorDB) organization to perform new uploads.
Ask Aaron to add your GitHub account to this organization if you want to perform uploads.
ðŸš¨ðŸš¨ðŸš¨

```{r, eval=FALSE}
# Setting an expiry date of 1 day in the future, to avoid having lots of
# testing projects lying around in the data store.
uploadDirectory(staging, project="test-vignette", expires=1)
```

By default, the current date is used as the version string, but users can specify another versioning scheme if appropriate.
The same `uploadDirectory()` call can be used to update an existing project by simply specifying another version:

```{r, eval=FALSE}
uploadDirectory(staging, project="test-vignette", version="v2", expires=1)
```

# `DelayedArray` wrappers for CollaboratorDB

For arrays, `r self` offers some special behavior during loading:

```{r}
mat <- fetchObject("dssc-test_basic-2023:my_first_sce/assay-1/matrix.h5@2023-01-19")
mat
```

The `CollaboratorDBArray` object is a [`DelayedArray`](https://bioconductor.org/packages/DelayedArray) subclass that remembers its ArtifactDB identifier.
This provides some optimization opportunities during the save/upload of the unmodified array,
and allows for cheap project updates, e.g., when editing the metadata or annotations of a `SummarizedExperiment` without touching the assay data.

The `CollaboratorDBArray` is created with file-backed arrays from the `r Biocpkg("HDF5Array")` package.
This ensures that it can be easily manipulated in an R session while maintaining a small memory footprint.
However, for analysis steps that actually use the array contents, it is best to convert the `CollaboratorDBArray` into an in-memory representation to avoid repeated disk queries:

```{r}
smat <- as(mat, "dgCMatrix")
str(smat)
```

# Searching for objects

ðŸš§ðŸš§ðŸš§ **Coming soon** ðŸš§ðŸš§ðŸš§

# Advanced usage

The **CollaboratorDB** API is just another ArtifactDB instance, so all methods in the `r Githubpkg("ArtifactDB/zircon-R", "zircon")` package can be used.
For example, we can directly fetch the metadata for individual components:

```{r}
library(zircon)
meta <- getFileMetadata(exampleID(), url=restURL())
str(meta$data_frame)
```

We can inspect the permissions for a project:

```{r}
getPermissions("dssc-test_basic-2023", url=restURL())
```

And we can pull down all metadata for a particular version of a project:

```{r}
v1.meta <- getProjectMetadata("dssc-test_tenx-2023", version="2023-01-19", url=restURL())
length(v1.meta)
```

# Session information {-}

```{r}
sessionInfo()
```
